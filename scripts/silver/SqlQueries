-- Correction in Crm_cst_info 

insert into silver.crm_cust_info(
cst_id,
cst_key,
cst_firstname,
cst_lastname,
cst_marital_status,
cst_gndr,
cst_create_date
)
select 
cst_id,cst_key,
trim(cst_firstname) as cst_firstname,
trim(cst_lastname) as cst_lastname,
case
when upper(trim(cst_marital_status))='M' then 'Married'
when upper(trim(cst_marital_status))='S' then 'Single'
else 'n/a'
end as cst_marital_status,
case
when upper(trim(cst_gndr))='M' then 'Male'
when upper(trim(cst_gndr))='F' then 'Female'
else 'n/a'
end as cst_gndr,
cst_create_date
from(
select*,
row_number() over(partition by cst_id order by cst_create_date desc) as row_num_rank
from bronze.crm_cust_info) as t
where row_num_rank=1 and cst_id is not null;




-- Correction on crm_prd_info table 

CREATE TABLE silver.crm_prd_info (
    prd_id       INT,
	cat_id       NVARCHAR(50),
    prd_key      NVARCHAR(50),
    prd_nm       NVARCHAR(50),
    prd_cost     INT,
    prd_line     NVARCHAR(50),
    prd_start_dt DATETIME,
    prd_end_dt   DATETIME,
	dwh_create_date DATETIME2 DEFAULT GETDATE()
);

insert into silver.crm_prd_info(
 prd_id,
 cat_id,
 prd_key,
 prd_nm,
 prd_cost,
 prd_line,
 prd_start_dt,
 prd_end_dt
 )
select prd_id, 
replace(substring(prd_key, 1,5),'-','_') as cat_id,
substring(prd_key, 7,len(prd_key)) as prd_key,
prd_nm,
isnull(prd_cost,0) as prd_cost,
case upper(trim(prd_line)) 
when 'M' then 'Mountain'
when 'R' then 'Road'
when'S' then 'Other Sales'
when'T' then 'Touring'
else 'n/a' end as prd_line,
cast(prd_start_dt as date) as prd_start_dt,
cast(lead(prd_start_dt) over(partition by prd_key order by prd_start_dt)-1 as date) as prd_end_dt
from bronze.crm_prd_info;


-- We need to change the data type of date as they are int type so before inserting the data we are going to change the data types in the table 

CREATE TABLE silver.crm_sales_details (
    sls_ord_num  NVARCHAR(50),
    sls_prd_key  NVARCHAR(50),
    sls_cust_id  INT,
    sls_order_dt DATE,
    sls_ship_dt  DATE,
    sls_due_dt   DATE,
    sls_sales    INT,
    sls_quantity INT,
    sls_price    INT,
	dwh_create_date DATETIME2 DEFAULT GETDATE()
);

-- insert into crm_sales_details 

INSERT into silver.crm_sales_details(
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    sls_order_dt, 
    sls_ship_dt,
    sls_due_dt,
    sls_sales,
    sls_quantity,
    sls_price
	)
select
sls_ord_num,
sls_prd_key,
sls_cust_id,
case
when sls_order_dt <0 or len(sls_order_dt) !=8 then null
else cast(cast(sls_order_dt as varchar) as date)
end as sls_order_dt ,
case
when sls_ship_dt <0 or len(sls_ship_dt) !=8 then null
else cast(cast(sls_ship_dt as varchar) as date)
end as sls_ship_dt ,
case
when sls_due_dt <0 or len(sls_due_dt) !=8 then null
else cast(cast(sls_due_dt as varchar) as date)
end as sls_due_dt,
case
when sls_sales<=0 or sls_sales is null or sls_sales!= sls_quantity* abs(sls_price)
then sls_quantity* abs(sls_price)
else sls_sales
end as sls_sales,
sls_quantity,
case
when sls_price<=0 or sls_price is null or sls_price!= sls_sales/sls_quantity
then sls_sales/nullif(sls_quantity,0)
else sls_price
end as sls_price
from bronze.crm_sales_details;

-- creating table and insert into silver  erp_cust_az12

CREATE TABLE silver.erp_cust_az12 (
    cid    NVARCHAR(50),
    bdate  DATE,
    gen    NVARCHAR(50),
	dwh_create_date DATETIME2 DEFAULT GETDATE()
);
insert into silver.erp_cust_az12 (
    cid,
    bdate,
    gen
	)
 select
 case 
 when cid like 'NAS%' then substring(cid,4,len(cid)) else cid
 end as cid,
	case 
  when bdate > getdate() then null
  else bdate
  end as bdate,
  case
  when upper(trim(gen)) in ('F','Female') then'FEMALE'
  when upper(trim(gen)) in ('M','Male') then 'MALE'
  else 'n/a'
  end as gen
  from bronze.erp_cust_az12;


--creating table and insert into silver erp_loc_a101

CREATE TABLE silver.erp_loc_a101 (
    cid    NVARCHAR(50),
    cntry  NVARCHAR(50),
	dwh_create_date DATETIME2 DEFAULT GETDATE()
);

insert into silver.erp_loc_a101 (
    cid,
    cntry
	)
  select
  replace(cid,'-','') as cid,
 case
 when trim(cntry) = 'DE' then 'Germany'
 when trim(cntry) in ('USA','US') then 'United States'
  when trim(cntry)='' or cntry is null then 'n/a'
  else trim(cntry)
  end as cntry
 from bronze.erp_loc_a101;

--creating table and insert into erp_px_cat_g1v2

CREATE TABLE silver.erp_px_cat_g1v2 (
    id           NVARCHAR(50),
    cat          NVARCHAR(50),
    subcat       NVARCHAR(50),
    maintenance  NVARCHAR(50),
	dwh_create_date DATETIME2 DEFAULT GETDATE()
);

INSERT INTO silver.erp_px_cat_g1v2 (
			id,
			cat,
			subcat,
			maintenance
		)
		SELECT
			id,
			cat,
			subcat,
			maintenance
		FROM bronze.erp_px_cat_g1v2;






